{% extends "boilerplate.html" %}
{% block body %}

<div class="container-fluid mt-3">
  <div class="row">
    <!-- Map Column -->
    <div class="col-md-8 mb-2">
      <div class="card-body" id="map" style="border-radius: 0.375rem; width: 100%; height: 580px">Click on markers to get directions</div>
    </div>
    
    <!-- Events List Column -->
    <div class="col-md-4">
      <div class="card" style="height: 580px;">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Event Details</h5>
        </div>
        <div class="card-body p-0">
          <div style="height: 530px; overflow-y: auto;">
            {% if query %}
              {% for event in events %}
              <div class="p-3 border-bottom">
                <h6 class="text-primary">{{event.name}}</h6>
                <p class="small mb-1">
                  <i class="far fa-clock mr-1"></i>
                  {{event.startTime|toIST}} to {{event.endTime|toIST}}
                </p>
                {% for location in event.locations %}
                <p class="small mb-1">
                  <i class="fas fa-map-marker-alt mr-1"></i>
                  {{location.name}}: {{location.latitude}}, {{location.longitude}}
                </p>
                {% endfor %}
              </div>
              {% endfor %}
            {% else %}
              {% for event in events %}
              <div class="p-3 border-bottom">
                <h6 class="text-primary">{{event.name}}</h6>
                <p class="small mb-1">
                  <i class="far fa-clock mr-1"></i>
                  {{event.startTime|toIST}} to {{event.endTime|toIST}}
                </p>
                {% for location in event.locations %}
                <p class="small mb-1">
                  <i class="fas fa-map-marker-alt mr-1"></i>
                  {{location.name}}: {{location.latitude}}, {{location.longitude}}
                </p>
                {% endfor %}
              </div>
              {% endfor %}
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Initialize map
  const coordinate = [12.988754577439247, 80.23507761724024];
  const map = L.map("map").setView(coordinate, 16);

  // Add OpenStreetMap tiles
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: 'Â© <a href="https://openstreetmap.org">OpenStreetMap</a>',
  }).addTo(map);

  // Geolocation
  let userLatLng = null;
  if ("geolocation" in navigator) {
    navigator.geolocation.watchPosition(
      (position) => {
        userLatLng = [position.coords.latitude, position.coords.longitude];
        window.userLatLng = userLatLng;
        
        if (window.userMarker) {
          window.userMarker.setLatLng(userLatLng);
        } else {
          window.userMarker = L.marker(userLatLng)
            .addTo(map)
            .bindPopup("You're here!")
            .openPopup();
        }
        
        map.setView(userLatLng, 15);
      },
      (error) => {
        console.error("Geolocation error:", error.message);
        alert("Unable to get your location. Please enable geolocation for directions.");
      },
      {
        enableHighAccuracy: true,
      }
    );
  }

  // Load KML layer
  const kmlLayer = omnivore.kml('/static/eventsmap.kml')
    .on('ready', function() {
      map.fitBounds(kmlLayer.getBounds());
      
      kmlLayer.eachLayer(function(layer) {
        if (layer instanceof L.Marker) {
          const name = layer.feature?.properties?.name || "Unnamed Place";
          const description = layer.feature?.properties?.description || "No description";
          
          layer.setIcon(L.icon({
            iconUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
          }));
          
          layer.bindTooltip(name, { 
            permanent: true, 
            direction: 'top',
            className: 'kml-label',
            offset: [0, -20]
          }).openTooltip();
          
          layer.on('click', function() {
            if (!window.userLatLng) {
              alert("Please enable geolocation and wait for your location to be detected.");
              return;
            }
            
            const origin = `${window.userLatLng[0]},${window.userLatLng[1]}`;
            const destination = `${layer.getLatLng().lat},${layer.getLatLng().lng}`;
            const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=walking`;
            
            layer.bindPopup(`
              <b>${name}</b><br>
              <p>${description}</p>
              <a href="${googleMapsUrl}" target="_blank" class="btn btn-primary btn-sm mt-2">
                <i class="fas fa-walking mr-1"></i> Get Walking Directions
              </a>
            `).openPopup();
          });
        }
        
        if (layer instanceof L.Polygon || layer instanceof L.Polyline) {
          layer.setStyle({
            color: '#3388ff',
            weight: 3,
            opacity: 0.7,
            fillOpacity: 0.2
          });
        }
      });
    })
    .on('error', function(e) {
      console.error("KML Error:", e.error);
      alert("Failed to load map data. Please try again later.");
    })
    .addTo(map);
</script>

<style>
  .kml-label {
    font-size: 12px;
    font-weight: bold;
    background: white;
    padding: 3px 6px;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  .card-body::-webkit-scrollbar {
    width: 8px;
  }
  .card-body::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  .card-body::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
  }
  .card-body::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
</style>

{% endblock %}